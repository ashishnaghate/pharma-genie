<div class="pg-chatbot-container" [class.pg-open]="isOpen">
  <!-- Chat Toggle Button -->
  <button class="pg-chat-toggle" (click)="toggleChat()" [attr.aria-label]="isOpen ? 'Close chat' : 'Open chat'">
    <svg *ngIf="!isOpen" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
      <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
    </svg>
    <svg *ngIf="isOpen" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
    </svg>
  </button>

  <!-- Chat Window -->
  <div class="pg-chat-window" *ngIf="isOpen">
    <!-- Header -->
    <div class="pg-chat-header">
      <div class="pg-header-content">
        <div class="pg-header-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
            <path d="M19.5 3.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2v14H3v3c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V2l-1.5 1.5zM19 19c0 .55-.45 1-1 1s-1-.45-1-1v-3H8V5h11v14z"/>
            <path d="M9 7h6v2H9zm7 0h2v2h-2zm-7 3h6v2H9zm7 0h2v2h-2z"/>
          </svg>
        </div>
        <div class="pg-header-text">
          <h3>PharmaGenie</h3>
          <p>{{ chatbotMode }}</p>
        </div>
      </div>
      <div class="pg-header-actions">
        <button class="pg-icon-btn" (click)="clearChat()" title="Clear chat" aria-label="Clear chat">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM8 9h8v10H8V9zm7.5-5l-1-1h-5l-1 1H5v2h14V4z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="pg-chat-body">
      <div class="pg-messages">
        <div *ngFor="let message of messages" 
             class="pg-message" 
             [class.pg-user]="message.sender === 'user'"
             [class.pg-bot]="message.sender === 'bot'">
          <div class="pg-message-avatar">
            <span *ngIf="message.sender === 'user'">ğŸ‘¤</span>
            <span *ngIf="message.sender === 'bot'">ğŸ§¬</span>
          </div>
          <div class="pg-message-content">
            <div class="pg-message-bubble">
              <!-- Text messages only -->
              <div *ngIf="message.type === 'text'" 
                   [innerHTML]="formatMessageContent(message)"></div>
              
              <!-- Consolidated data view (HTML formatted) -->
              <div *ngIf="message.type === 'list' && message.data?.statistics">
                <div [innerHTML]="message.text"></div>
                <!-- Show expandable details below the summary -->
                <details style="margin-top: 15px;">
                  <summary style="cursor: pointer; font-weight: bold; color: #667eea; padding: 8px; background: #f0f4ff; border-radius: 4px;">
                    ğŸ“‹ View Detailed Records
                  </summary>
                  <div style="margin-top: 10px;">
                    <!-- Trials -->
                    <div *ngIf="message.data.trials && message.data.trials.length > 0" class="pg-trials-list" style="margin-bottom: 15px;">
                      <h4 style="margin: 10px 0 5px 0; color: #667eea; font-size: 14px;">ğŸ”¬ Clinical Trials ({{message.data.trials.length}})</h4>
                      <div *ngFor="let trial of message.data.trials.slice(0, 5)" class="pg-trial-item">
                        <div class="pg-trial-header">
                          <strong>{{ trial.id || trial.trialId }}</strong>
                          <span class="pg-badge" [ngClass]="'pg-status-' + trial.status?.toLowerCase()">
                            {{ trial.status }}
                          </span>
                        </div>
                        <div class="pg-trial-title">{{ trial.title }}</div>
                        <div class="pg-trial-meta">
                          <span>{{ trial.drug }}</span> â€¢ 
                          <span>{{ trial.phase }}</span> â€¢ 
                          <span>{{ trial.indication }}</span>
                        </div>
                      </div>
                      <div *ngIf="message.data.trials.length > 5" style="text-align: center; padding: 8px; color: #666; font-size: 12px;">
                        ... and {{ message.data.trials.length - 5 }} more trials
                      </div>
                    </div>
                    
                    <!-- Drugs -->
                    <div *ngIf="message.data.drugs && message.data.drugs.length > 0" class="pg-trials-list" style="margin-bottom: 15px;">
                      <h4 style="margin: 10px 0 5px 0; color: #e91e63; font-size: 14px;">ğŸ’Š Drugs ({{message.data.drugs.length}})</h4>
                      <div *ngFor="let drug of message.data.drugs.slice(0, 5)" class="pg-trial-item">
                        <div class="pg-trial-header">
                          <strong>{{ drug.drugId }}</strong>
                          <span class="pg-badge">{{ drug.class }}</span>
                        </div>
                        <div class="pg-trial-title">{{ drug.name }}</div>
                        <div class="pg-trial-meta">
                          <span>{{ drug.approvalStatus?.FDA ? 'FDA Approved' : (drug.approvalStatus?.status || drug.approvalStatus || 'Status Unknown') }}</span>
                        </div>
                      </div>
                      <div *ngIf="message.data.drugs.length > 5" style="text-align: center; padding: 8px; color: #666; font-size: 12px;">
                        ... and {{ message.data.drugs.length - 5 }} more drugs
                      </div>
                    </div>
                    
                    <!-- Sites -->
                    <div *ngIf="message.data.sites && message.data.sites.length > 0" class="pg-trials-list" style="margin-bottom: 15px;">
                      <h4 style="margin: 10px 0 5px 0; color: #4caf50; font-size: 14px;">ğŸ¥ Trial Sites ({{message.data.sites.length}})</h4>
                      <div *ngFor="let site of message.data.sites" class="pg-trial-item">
                        <div class="pg-trial-header">
                          <strong>{{ site.siteId }}</strong>
                        </div>
                        <div class="pg-trial-title">{{ site.name }}</div>
                        <div class="pg-trial-meta">
                          <span>{{ site.city }}, {{ site.country }}</span> â€¢ 
                          <span>Capacity: {{ site.capacity }}</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Participants -->
                    <div *ngIf="message.data.participants && message.data.participants.length > 0" class="pg-trials-list" style="margin-bottom: 15px;">
                      <h4 style="margin: 10px 0 5px 0; color: #ff9800; font-size: 14px;">ğŸ‘¥ Participants ({{message.data.participants.length}})</h4>
                      <div *ngFor="let participant of message.data.participants" class="pg-trial-item">
                        <div class="pg-trial-header">
                          <strong>{{ participant.participantId }}</strong>
                          <span class="pg-badge">{{ participant.enrollmentStatus }}</span>
                        </div>
                        <div class="pg-trial-meta">
                          <span>Age: {{ participant.age }}</span> â€¢ 
                          <span>Gender: {{ participant.gender }}</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Adverse Events -->
                    <div *ngIf="message.data.adverseEvents && message.data.adverseEvents.length > 0" class="pg-trials-list">
                      <h4 style="margin: 10px 0 5px 0; color: #f44336; font-size: 14px;">âš ï¸ Adverse Events ({{message.data.adverseEvents.length}})</h4>
                      <div *ngFor="let event of message.data.adverseEvents" class="pg-trial-item">
                        <div class="pg-trial-header">
                          <strong>{{ event.eventId }}</strong>
                          <span class="pg-badge" [style.background]="event.isSerious ? '#f44336' : '#ff9800'">
                            {{ event.severity }} {{ event.isSerious ? '(Serious)' : '' }}
                          </span>
                        </div>
                        <div class="pg-trial-meta">
                          <span>{{ event.description }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </details>
                
                <!-- Export buttons for consolidated data (NLP mode only) -->
                <div *ngIf="!isGenAIMode && message.data.summary && message.data.summary.totalRecords > 1" class="pg-export-actions" style="margin-top: 15px;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">
                    ğŸ“¥ Export {{ message.data.summary.totalRecords }} records:
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <button *ngIf="canExportCSV(message)" class="pg-btn-export csv-btn" (click)="exportMessageData(message, 'csv')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                      </svg>
                      CSV
                    </button>
                    <button class="pg-btn-export excel-btn" (click)="exportMessageData(message, 'excel')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                      </svg>
                      Excel
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="pg-message-time">
              {{ message.timestamp | date:'short' }}
            </div>
          </div>
        </div>

        <div *ngIf="isLoading" class="pg-message pg-bot">
          <div class="pg-message-avatar">
            <span>ğŸ§¬</span>
          </div>
          <div class="pg-message-content">
            <div class="pg-message-bubble">
              <div class="pg-typing-indicator">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Footer -->
    <div class="pg-chat-footer">
      <div class="pg-input-container">
        <textarea
          [(ngModel)]="userInput"
          (keydown)="handleKeyPress($event)"
          placeholder="Ask about clinical trials..."
          rows="1"
          [disabled]="isLoading"
          aria-label="Type your message"
        ></textarea>
        <button 
          class="pg-send-btn" 
          (click)="sendMessage()" 
          [disabled]="!userInput.trim() || isLoading"
          aria-label="Send message">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
      <div class="pg-footer-info">
        <small>Powered by PharmaGenie AI</small>
      </div>
    </div>
  </div>
</div>
